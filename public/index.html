<!-- <!DOCTYPE html>
<html>
<head>
  <title>Upload Excel File</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="upload-container">
    <h1>Upload Excel File / UNIQUE DATABASE</h1>
    <form action="/upload" method="POST" enctype="multipart/form-data">
      <input type="file" name="excel" required accept=".xlsx, .xls" />
      <br />
      <button type="submit">Upload</button>
    </form>
  </div>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Excel Upload and Fetch</title>
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form action="/upload" method="POST" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr>

  <h2>üìÑ Fetch Sheet Data</h2>
  <label>Database Name:</label>
  <input type="text" id="dbName" placeholder="e.g., excel_upload_2025-08-05T09-45-00-000Z" required><br><br>
  <label>Sheet Name:</label>
  <input type="text" id="sheetName" placeholder="e.g., Sheet1" required><br><br>
  <button onclick="fetchData()">Fetch Data</button>

  <pre id="result"></pre>

  <script>
    async function fetchData() {
      const dbName = document.getElementById('dbName').value;
      const sheetName = document.getElementById('sheetName').value;

      const response = await fetch(`/fetch-data?dbName=${dbName}&sheetName=${sheetName}`);
      const resultBox = document.getElementById('result');

      if (response.ok) {
        const data = await response.json();
        resultBox.textContent = JSON.stringify(data, null, 2);
      } else {
        const text = await response.text();
        resultBox.textContent = text;
      }
    }
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Excel Upload and Fetch</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form action="/upload" method="POST" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr>

  <h2>üìÑ Fetch Sheet Data</h2>
  <label>Database Name:</label>
  <input type="text" id="dbName" placeholder="e.g., excel_upload_2025-08-05T09-45-00-000Z" required><br><br>
  <label>Sheet Name:</label>
  <input type="text" id="sheetName" placeholder="e.g., Sheet1" required><br><br>
  <button onclick="fetchData()">Fetch Data</button>

  <div id="error"></div>
  <div id="resultTable"></div>

  <script>
    async function fetchData() {
      const dbName = document.getElementById('dbName').value;
      const sheetName = document.getElementById('sheetName').value;
      const resultTable = document.getElementById('resultTable');
      const errorBox = document.getElementById('error');
      resultTable.innerHTML = '';
      errorBox.textContent = '';

      try {
        const response = await fetch(`/fetch-data?dbName=${dbName}&sheetName=${sheetName}`);

        if (!response.ok) {
          const errorText = await response.text();
          errorBox.textContent = errorText;
          return;
        }

        const data = await response.json();

        if (!data.length) {
          resultTable.innerHTML = '<p>No data found in this sheet.</p>';
          return;
        }

        // Generate table headers
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const columns = Object.keys(data[0]);
        for (const col of columns) {
          const th = document.createElement('th');
          th.textContent = col;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Generate table rows
        const tbody = document.createElement('tbody');
        for (const row of data) {
          const tr = document.createElement('tr');
          for (const col of columns) {
            const td = document.createElement('td');
            td.textContent = row[col] !== undefined ? row[col] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        resultTable.appendChild(table);
      } catch (error) {
        errorBox.textContent = '‚ùå Failed to fetch or display data';
        console.error(error);
      }
    }
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Excel Upload & Filter</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form action="/upload" method="POST" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr>

  <h2>üîç Filter Data From Database</h2>

  <label>Database Name:</label>
  <input type="text" id="dbName" placeholder="e.g., excel_upload_2025-08-05T12-30-00-000Z" required><br><br>

  <label>Annexure:</label>
  <input type="text" id="annexure" placeholder="Optional"><br><br>

  <label>Case Type:</label>
  <input type="text" id="caseType" placeholder="Optional"><br><br>

  <button onclick="fetchFilteredData()">Apply Filters</button>

  <div id="error"></div>
  <div id="resultTable"></div>

  <script>
    async function fetchFilteredData() {
      const dbName = document.getElementById('dbName').value;
      const annexure = document.getElementById('annexure').value;
      const caseType = document.getElementById('caseType').value;
      const resultTable = document.getElementById('resultTable');
      const errorBox = document.getElementById('error');

      resultTable.innerHTML = '';
      errorBox.textContent = '';

      const queryParams = new URLSearchParams({ dbName });
      if (annexure) queryParams.append('annexure', annexure);
      if (caseType) queryParams.append('caseType', caseType);

      try {
        const response = await fetch(`/fetch-data?${queryParams}`);

        if (!response.ok) {
          const errorText = await response.text();
          errorBox.textContent = errorText;
          return;
        }

        const data = await response.json();

        if (!data.length) {
          resultTable.innerHTML = '<p>No data found.</p>';
          return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const columns = Object.keys(data[0]);
        for (const col of columns) {
          const th = document.createElement('th');
          th.textContent = col;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (const row of data) {
          const tr = document.createElement('tr');
          for (const col of columns) {
            const td = document.createElement('td');
            td.textContent = row[col] !== undefined ? row[col] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        resultTable.appendChild(table);
      } catch (error) {
        errorBox.textContent = '‚ùå Failed to fetch or display data.';
        console.error(error);
      }
    }
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Excel to MongoDB App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    input, button {
      margin: 10px 0;
      padding: 8px;
      width: 300px;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
      width: 100%;
    }
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>üìä Excel Upload & Filter</h1>

  <h2>üìÅ Upload Excel File</h2>
  <form id="uploadForm">
    <input type="file" name="file" required><br>
    <button type="submit">Upload</button>
  </form>
  <div id="uploadResult"></div>

  <hr>

  <h2>üîç Filter Data</h2>
  <input type="text" id="dbName" placeholder="Database Name (after upload)" required><br>
  <input type="text" id="companyName" placeholder="Company Name (optional)"><br>
  <input type="text" id="product" placeholder="Product (optional)"><br>
  <button onclick="fetchFilteredData()">Apply Filters</button>
  <div id="error"></div>
  <div id="resultTable"></div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const resultBox = document.getElementById('uploadResult');
      resultBox.textContent = 'Uploading...';

      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (res.ok) {
          resultBox.textContent = `‚úÖ Upload successful! DB Name: ${data.dbName}`;
          document.getElementById('dbName').value = data.dbName;
        } else {
          resultBox.textContent = data.message || '‚ùå Upload failed.';
        }
      } catch (err) {
        resultBox.textContent = '‚ùå Upload error.';
        console.error(err);
      }
    });

    async function fetchFilteredData() {
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;
      const resultTable = document.getElementById('resultTable');
      const errorBox = document.getElementById('error');

      resultTable.innerHTML = '';
      errorBox.textContent = '';

      const queryParams = new URLSearchParams({ dbName });
      if (companyName) queryParams.append('companyName', companyName);
      if (product) queryParams.append('product', product);

      try {
        const response = await fetch(`/fetch-data?${queryParams}`);
        const data = await response.json();

        if (!response.ok) {
          errorBox.textContent = data;
          return;
        }

        if (!data.length) {
          resultTable.innerHTML = '<p>No data found.</p>';
          return;
        }

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const columns = Object.keys(data[0]);
        for (const col of columns) {
          const th = document.createElement('th');
          th.textContent = col;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (const row of data) {
          const tr = document.createElement('tr');
          for (const col of columns) {
            const td = document.createElement('td');
            td.textContent = row[col] !== undefined ? row[col] : '';
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        resultTable.appendChild(table);
      } catch (error) {
        errorBox.textContent = '‚ùå Failed to fetch or display data.';
        console.error(error);
      }
    }
  </script>
</body>
</html> -->

<!-- this is completely working -->

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Excel to MongoDB Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr>

  <h2>üîç Fetch Data from MongoDB</h2>
  <form id="fetchForm">
    <input type="text" id="dbName" placeholder="Enter Database Name" required />
    <input type="text" id="companyName" placeholder="Company Name (Optional)" />
    <input type="text" id="product" placeholder="Product (Optional)" />
    <button type="submit">Fetch Data</button>
  </form>

  <div id="output"></div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = "Loading...";
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dbName, companyName, product })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p style="color:red;">${error}</p>`;
        return;
      }

      const data = await res.json();
      if (data.length === 0) {
        output.innerHTML = `<p>No matching data found.</p>`;
        return;
      }

      let html = `<h3>Fetched ${data.length} Records</h3><table border="1"><thead><tr>`;
      Object.keys(data[0]).forEach(key => html += `<th>${key}</th>`);
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        Object.values(row).forEach(val => html += `<td>${val}</td>`);
        html += '</tr>';
      });

      html += '</tbody></table>';
      output.innerHTML = html;
    });
  </script>
</body>
</html> -->

<!-- this is the final one with all working condition -->

<!-- <!DOCTYPE html>
<html>
<head>
  <title>Excel to MongoDB Viewer</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .sheet-section {
      border: 1px solid #ccc;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
      background-color: #f5f5f5;
    }
    .sheet-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    .records-table {
      margin-top: 10px;
      display: none;
    }
    .show {
      display: block;
    }
    button.toggle-btn {
      background-color: #4CAF50;
      color: white;
      padding: 5px 10px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr>

  <h2>üîç Fetch Data from MongoDB</h2>
  <form id="fetchForm">
    <input type="text" id="dbName" placeholder="Enter Database Name" required />
    <input type="text" id="companyName" placeholder="Company Name (Optional)" />
    <input type="text" id="product" placeholder="Product (Optional)" />
    <button type="submit">Fetch Data</button>
  </form>

  <div id="output"></div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = "Loading...";
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dbName, companyName, product })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p style="color:red;">${error}</p>`;
        return;
      }

      const data = await res.json();

      // Group by sheet name
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              ${sheetName} (${rows.length} matching record${rows.length > 1 ? 's' : ''})
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <table border="1">
                <thead>
                  <tr>
                    ${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`)
                      .join('')}
                  </tr>
                </thead>
                <tbody>
                  ${rows
                    .map(
                      row =>
                        `<tr>${Object.entries(row)
                          .filter(([k]) => k !== 'sheet')
                          .map(([, v]) => `<td>${v}</td>`)
                          .join('')}</tr>`
                    )
                    .join('')}
                </tbody>
              </table>
            </div>
          </div>`;
      }

      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel to MongoDB Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr />

  <h2>üîç Fetch Data from MongoDB</h2>
  <form id="fetchForm">
    <input type="text" id="dbName" placeholder="Enter Database Name" required />
    <input type="text" id="companyName" placeholder="Company Name (Optional)" />
    <input type="text" id="product" placeholder="Product (Optional)" />
    <button type="submit">Fetch Data</button>
  </form>

  <div id="output"></div>

  <div id="popup" class="popup">
    <div class="popup-content" id="popup-content"></div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = "Loading...";
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dbName, companyName, product })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p style="color:red;">${error}</p>`;
        return;
      }

      const data = await res.json();
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              <strong>${sheetName}</strong> (${rows.length} record${rows.length > 1 ? 's' : ''})
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(row => `
                      <tr>${Object.entries(row)
                        .filter(([k]) => k !== 'sheet')
                        .map(([k, v]) => {
                          const text = String(v || '');
                          return `<td onclick="showPopup(\`${text.replace(/`/g, '\\`')}\`)">
                                    ${text.length > 100 ? text.substring(0, 100) + '... <em>Read more</em>' : text}
                                  </td>`;
                        }).join('')}
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      }

      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }

    function showPopup(content) {
      popupContent.textContent = content;
      popup.style.display = 'flex';
    }

    popup.onclick = () => {
      popup.style.display = 'none';
    };
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel to MongoDB Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr />

  <h2>üîç Fetch Data from MongoDB</h2>
  <form id="fetchForm">
    <input type="text" id="dbName" placeholder="Enter Database Name" required />
    <input type="text" id="companyName" placeholder="Company Name (Optional)" />
    <input type="text" id="product" placeholder="Product (Optional)" />
    <button type="submit">Fetch Data</button>
  </form>

  <div id="output"></div>

  <div id="popup" class="popup">
    <div class="popup-content" id="popup-content"></div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = "Loading...";
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dbName, companyName, product })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p style="color:red;">${error}</p>`;
        return;
      }

      const data = await res.json();
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      // --- MODIFIED SECTION START ---
      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              <div class="sheet-info">
                <strong>${sheetName}</strong>
                <span class="record-count">(${rows.length} record${rows.length > 1 ? 's' : ''})</span>
              </div>
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(row => `
                      <tr>${Object.entries(row)
                        .filter(([k]) => k !== 'sheet')
                        .map(([k, v]) => {
                          const text = String(v || '');
                          if (text.length > 100) {
                            return `<td>
                                      ${text.substring(0, 100)}...
                                      <span class="read-more" onclick="showPopup(\`${text.replace(/`/g, '\\`')}\`)">Read more</span>
                                    </td>`;
                          } else {
                            return `<td>${text}</td>`;
                          }
                        }).join('')}
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      }
      // --- MODIFIED SECTION END ---

      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }

    function showPopup(content) {
      popupContent.textContent = content;
      popup.style.display = 'flex';
    }

    popup.onclick = () => {
      popup.style.display = 'none';
    };
  </script>
</body>
</html> -->

<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel to MongoDB Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>üì§ Upload Excel File</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="excel" required />
    <button type="submit">Upload</button>
  </form>

  <hr />

  <h2>üîç Fetch Data from MongoDB</h2>
  <form id="fetchForm">
    <input type="text" id="dbName" placeholder="Enter Database Name" required />
    <input type="text" id="companyName" placeholder="Company Name (Optional)" />
    <input type="text" id="product" placeholder="Product (Optional)" />
    <input type="date" id="dateFrom" title="Date From" />
    <input type="date" id="dateTo" title="Date To" />
    <button type="submit">Fetch Data</button>
    <button type="button" id="resetBtn">Reset Filters</button>
  </form>

  <div id="output"></div>

  <div id="popup" class="popup">
    <div class="popup-content" id="popup-content"></div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');

    // ‚ú® ADDED: Logic for the new Reset button
    const resetBtn = document.getElementById('resetBtn');
    resetBtn.addEventListener('click', () => {
      // Clear all the input fields in the form
      document.getElementById('dbName').value = '';
      document.getElementById('companyName').value = '';
      document.getElementById('product').value = '';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';

      // Clear the results display area
      output.innerHTML = '';
    });


    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const res = await fetch('/upload', {
        method: 'POST',
        body: formData
      });
      const text = await res.text();
      alert(text);
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = "Loading...";
      const dbName = document.getElementById('dbName').value;
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dbName, companyName, product, dateFrom, dateTo })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p style="color:red;">${error}</p>`;
        return;
      }

      const data = await res.json();
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              <div class="sheet-info">
                <strong>${sheetName}</strong>
                <span class="record-count">(${rows.length} record${rows.length > 1 ? 's' : ''})</span>
              </div>
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(row => `
                      <tr>${Object.entries(row)
                        .filter(([k]) => k !== 'sheet')
                        .map(([k, v]) => {
                          const text = String(v || '');
                          if (text.length > 100) {
                            return `<td>
                                      ${text.substring(0, 100)}...
                                      <span class="read-more" onclick="showPopup(\`${text.replace(/`/g, '\\`')}\`)">Read more</span>
                                    </td>`;
                          } else {
                            return `<td>${text}</td>`;
                          }
                        }).join('')}
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      }

      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }

    function showPopup(content) {
      popupContent.textContent = content;
      popup.style.display = 'flex';
    }

    popup.onclick = () => {
      popup.style.display = 'none';
    };
  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easy_Search</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h1>Easy_Search</h1>
      <p style="color: black;">Analyze and query your spreadsheet data with ease.</p>
    </div>

    <div class="search-container">
      <h2>Search All Records Across All Sheets</h2>
      <form id="fetchForm">
        <div class="form-group">
          <label for="companyName">Company Name (keyword search)</label>
          <input type="text" id="companyName" placeholder="Enter company keyword...">
        </div>
        <div class="form-group">
          <label for="product">Product (keyword search)</label>
          <input type="text" id="product" placeholder="Enter product keyword...">
        </div>
        <div class="form-group">
          <label for="dateFrom">Date From</label>
          <input type="date" id="dateFrom" title="Date From" />
        </div>
        <div class="form-group">
          <label for="dateTo">Date To</label>
          <input type="date" id="dateTo" title="Date To" />
        </div>
        <div class="form-actions">
            <button type="submit">Fetch Data</button>
            <button type="button" id="resetBtn">Reset Filters</button>
        </div>
      </form>
      <div class="hint">
        <p>üí° Use date range to filter records between specific dates</p>
      </div>
    </div>

    <div id="output"></div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-content" id="popup-content"></div>
  </div>

  <script>
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => {
      // Clear only the filter input fields
      document.getElementById('companyName').value = '';
      document.getElementById('product').value = '';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      output.innerHTML = '';
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = `<p class="loading-text">Loading...</p>`;
      
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // dbName is no longer sent from the frontend
        body: JSON.stringify({ companyName, product, dateFrom, dateTo })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p class="error-text">${error}</p>`;
        return;
      }

      const data = await res.json();
      if (data.length === 0) {
        output.innerHTML = '<p class="error-text">‚ùå No matching records found</p>';
        return;
      }
      
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              <div class="sheet-info">
                <strong>${sheetName}</strong>
                <span class="record-count">(${rows.length} record${rows.length > 1 ? 's' : ''})</span>
              </div>
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(row => `
                      <tr>${Object.entries(row)
                        .filter(([k]) => k !== 'sheet')
                        .map(([k, v]) => {
                          const text = String(v || '');
                          if (text.length > 100) {
                            return `<td>
                                      ${text.substring(0, 100)}...
                                      <span class="read-more" onclick="showPopup(\`${text.replace(/`/g, '\\`')}\`)">Read more</span>
                                    </td>`;
                          } else {
                            return `<td>${text}</td>`;
                          }
                        }).join('')}
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      }
      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }

    function showPopup(content) {
      popupContent.textContent = content;
      popup.style.display = 'flex';
    }

    popup.onclick = () => {
      popup.style.display = 'none';
    };
  </script>

   <footer>
    <p>Made using Javascript & Node | Database - MongoDB</p>
  </footer>
</body>
</html>