<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easy_Search</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header-container">
      <h1>Indian Agrochemical Registration Committee Updates</h1>
      <p style="color: black;"></p>
    </div>

    <div class="search-container">
      <h2>Search All Records Across All Sheets</h2>
      <form id="fetchForm">
        <div class="form-group">
          <label for="companyName">Company Name</label>
          <input type="text" id="companyName" placeholder="Enter company...">
        </div>
        <div class="form-group">
          <label for="product">Product</label>
          <input type="text" id="product" placeholder="Enter product...">
        </div>
        <div class="form-group">
          <label for="dateFrom">Date From</label>
          <input type="date" id="dateFrom" title="Date From" />
        </div>
        <div class="form-group">
          <label for="dateTo">Date To</label>
          <input type="date" id="dateTo" title="Date To" />
        </div>
        <div class="form-actions">
            <button type="submit">Fetch Data</button>
            <button type="button" id="resetBtn">Reset Filters</button>
        </div>
      </form>
      <div class="hint">
        <p>üí° Use date range to filter records between specific dates</p>
      </div>
    </div>

    <div id="output"></div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-content" id="popup-content"></div>
  </div>

  <script>
    const fetchForm = document.getElementById('fetchForm');
    const output = document.getElementById('output');
    const popup = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => {
      // Clear only the filter input fields
      document.getElementById('companyName').value = '';
      document.getElementById('product').value = '';
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      output.innerHTML = '';
    });

    fetchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      output.innerHTML = `<p class="loading-text">Loading...</p>`;
      
      const companyName = document.getElementById('companyName').value;
      const product = document.getElementById('product').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;

      const res = await fetch('/fetch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // dbName is no longer sent from the frontend
        body: JSON.stringify({ companyName, product, dateFrom, dateTo })
      });

      if (!res.ok) {
        const error = await res.text();
        output.innerHTML = `<p class="error-text">${error}</p>`;
        return;
      }

      const data = await res.json();
      if (data.length === 0) {
        output.innerHTML = '<p class="error-text">‚ùå No matching records found</p>';
        return;
      }
      
      const grouped = {};
      data.forEach(row => {
        if (!grouped[row.sheet]) grouped[row.sheet] = [];
        grouped[row.sheet].push(row);
      });

      let html = `<h3>Search Results Summary</h3>`;
      html += `<p>Total Records Found: <strong>${data.length}</strong></p>`;

      for (const [sheetName, rows] of Object.entries(grouped)) {
        html += `
          <div class="sheet-section">
            <div class="sheet-header">
              <div class="sheet-info">
                <strong>${sheetName}</strong>
                <span class="record-count">(${rows.length} record${rows.length > 1 ? 's' : ''})</span>
              </div>
              <button class="toggle-btn" onclick="toggleTable(this)">+ Show Records</button>
            </div>
            <div class="records-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>${Object.keys(rows[0])
                      .filter(k => k !== 'sheet')
                      .map(k => `<th>${k}</th>`).join('')}
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(row => `
                      <tr>${Object.entries(row)
                        .filter(([k]) => k !== 'sheet')
                        .map(([k, v]) => {
                          const text = String(v || '');
                          if (text.length > 100) {
                            return `<td>
                                      ${text.substring(0, 100)}...
                                      <span class="read-more" onclick="showPopup(\`${text.replace(/`/g, '\\`')}\`)">Read more</span>
                                    </td>`;
                          } else {
                            return `<td>${text}</td>`;
                          }
                        }).join('')}
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>`;
      }
      output.innerHTML = html;
    });

    function toggleTable(button) {
      const tableDiv = button.closest('.sheet-section').querySelector('.records-table');
      const isVisible = tableDiv.classList.contains('show');
      tableDiv.classList.toggle('show');
      button.textContent = isVisible ? '+ Show Records' : '- Hide Records';
    }

    function showPopup(content) {
      popupContent.textContent = content;
      popup.style.display = 'flex';
    }

    popup.onclick = () => {
      popup.style.display = 'none';
    };
  </script>

   <footer>
    <p>Made using Javascript & Node | Database - MongoDB</p>
  </footer>
</body>
</html>