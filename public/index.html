<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Easy Search</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>Indian Agrochemical Registration Committee Updates</h1>
        </div>

        <div class="search-container">
            <form id="fetchForm">
                <div class="form-group">
                    <label for="companyName">Company Name</label>
                    <input type="text" id="companyName" placeholder="Enter Company Name">
                </div>
                <div class="form-group">
                    <label for="product">Product Name</label>
                    <input type="text" id="product" placeholder="Enter Product Name">
                </div>
                <div class="form-group">
                    <label for="dateFrom">Date From</label>
                    <input type="date" id="dateFrom" title="Date From" />
                </div>
                <div class="form-group">
                    <label for="dateTo">Date To</label>
                    <input type="date" id="dateTo" title="Date To" />
                </div>
                <div class="form-actions">
                    <button type="submit">Click to search</button>
                    <button type="button" id="resetBtn">Reset Filters</button>
                </div>
            </form>
        </div>

        <div id="output"></div>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content" id="popup-content"></div>
    </div>

    <script>
        const fetchForm = document.getElementById('fetchForm');
        const output = document.getElementById('output');
        const popup = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const resetBtn = document.getElementById('resetBtn');
        let groupedData = {};
        let rcDateMap = {};

        resetBtn.addEventListener('click', () => {
            fetchForm.reset();
            output.innerHTML = '';
            groupedData = {};
            rcDateMap = {};
        });

        fetchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            output.innerHTML = `<p class="loading-text">Loading...</p>`;
            const body = {
                companyName: document.getElementById('companyName').value,
                product: document.getElementById('product').value,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
            };
            try {
                const res = await fetch('/fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const error = await res.text();
                    output.innerHTML = `<p class="error-text">${error}</p>`;
                    return;
                }
                
                const responsePayload = await res.json();
                const data = responsePayload.results;
                rcDateMap = responsePayload.rcDateMap;

                if (!data || data.length === 0) {
                    output.innerHTML = '<p class="error-text">‚ùå No matching records found</p>';
                    return;
                }
                
                // --- üí° NEW SORTING LOGIC ADDED HERE ---
                data.sort((a, b) => {
                    // Helper function to get and clean the RC number from a row
                    const getCleanRcNum = (row) => {
                        const rawRc = row.RC_Number || row['RC Number'];
                        if (!rawRc) {
                            return 0; // Treat rows without an RC number as the lowest value
                        }
                        // Clean the string (e.g., "463rd" -> "463") and parse to an integer
                        return parseInt(String(rawRc).replace(/[^0-9]/g, ""), 10) || 0;
                    };

                    const rcNumA = getCleanRcNum(a);
                    const rcNumB = getCleanRcNum(b);

                    // Sort in descending order (highest number first)
                    return rcNumB - rcNumA;
                });
                // --- END OF NEW SORTING LOGIC ---

                groupedData = {};
                data.forEach(row => {
                    if (!groupedData[row.sheet]) groupedData[row.sheet] = [];
                    groupedData[row.sheet].push(row);
                });
                
                let html = `
                    <div class="results-header">
                        <h3>Search Results</h3>
                        <p>Total Records Found: <strong>${data.length}</strong></p>
                    </div>
                    <div class="grid-container">`;
                const sheetEntries = Object.entries(groupedData);
                const itemsPerRow = 3;
                for (let i = 0; i < sheetEntries.length; i += itemsPerRow) {
                    html += `<div class="grid-row">`;
                    const rowItems = sheetEntries.slice(i, i + itemsPerRow);
                    rowItems.forEach(([sheetName, rows]) => {
                        html += `
                            <div class="grid-item">
                                <strong>${sheetName}</strong>
                                <p class="record-count">(${rows.length} record${rows.length > 1 ? 's' : ''})</p>
                                <button class="show-records-btn" onclick="showRecords('${sheetName.replace(/'/g, "\\'")}')">+ Show Records</button>
                            </div>`;
                    });
                    for (let j = rowItems.length; j < itemsPerRow; j++) {
                        html += `<div class="grid-item"></div>`;
                    }
                    html += `</div>`;
                }
                html += `</div><div id="table-display-area"></div>`;
                output.innerHTML = html;
            } catch (err) {
                console.error("Fetch processing error:", err);
                output.innerHTML = `<p class="error-text">‚ùå An error occurred while processing the data. Please check the console.</p>`;
            }
        });

        function showRecords(sheetName) {
            const tableArea = document.getElementById('table-display-area');
            const rows = groupedData[sheetName];

            if (!rows || rows.length === 0) {
                tableArea.innerHTML = '<p class="error-text">No records to display.</p>';
                return;
            }
            
            const headers = Object.keys(rows[0]).filter(k => k !== 'sheet');

            const tableBody = rows.map(row => {
                const cells = headers.map(header => {
                    const value = row[header] || '';
                    const rcNumRaw = row['RC_Number'] || row['RC Number'];

                    if (header === 'Page No' && rcNumRaw && value) {
                        const rcNumClean = String(rcNumRaw).replace(/[^0-9]/g, "");
                        return `<td><a href="/pdf/${rcNumClean}#page=${value}" target="_blank" title="Open PDF at page ${value}">${value}</a></td>`;
                    }

                    let displayValue = String(value);

                    if ((header === 'RC_Number' || header === 'RC Number') && value) {
                        // We use the raw value for display, not the cleaned one
                        const rcNumForDisplay = String(rcNumRaw).trim();
                        // We use the cleaned number for the map lookup
                        const rcNumForLookup = String(rcNumRaw).replace(/[^0-9]/g, "");
                        const meetingDate = rcDateMap[rcNumForLookup];
                        
                        if (meetingDate) {
                            displayValue = `${rcNumForDisplay} (${meetingDate})`;
                        } else {
                            displayValue = rcNumForDisplay;
                        }
                    }
                    
                    if (displayValue.length > 100) {
                        return `<td>
                                    ${displayValue.substring(0, 100)}...
                                    <span class="read-more" onclick="showPopup(\`${displayValue.replace(/`/g, '\\`')}\`)">Read more</span>
                                </td>`;
                    }
                    return `<td>${displayValue}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            
            const tableHtml = `
                <div class="table-container">
                    <h4>Records for: ${sheetName} <button class="hide-btn" onclick="hideRecords()">Close</button></h4>
                    <div class="table-scroll">
                        <table>
                            <thead>
                                <tr>${headers.map(k => {
                                    if (k === 'RC_Number' || k === 'RC Number') {
                                        return `<th>RC Number (Date)</th>`;
                                    }
                                    return `<th>${k}</th>`;
                                }).join('')}</tr>
                            </thead>
                            <tbody>${tableBody}</tbody>
                        </table>
                    </div>
                </div>`;
                
            tableArea.innerHTML = tableHtml;
        }

        function hideRecords() {
            document.getElementById('table-display-area').innerHTML = '';
        }

        function showPopup(content) {
            popup.style.display = 'flex';
            popupContent.textContent = content;
        }

        popup.onclick = (e) => {
            if (e.target === popup) {
                popup.style.display = 'none';
            }
        };
    </script>
</body>
</html>
